{% extends 'base.html.twig' %}

{% block title %}Modifier le produit - Admin
{% endblock %}

{% block body %}
	<div class="container admin-container" style="margin-top: 3rem; margin-bottom: 5rem;">
		<div class="admin-header" style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 3rem;">
			<div>
				<nav aria-label="breadcrumb">
					<ol style="list-style: none; padding: 0; display: flex; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 0.5rem;">
						<li>
							<a href="{{ path('app_admin_products') }}" style="color: var(--color-primary); text-decoration: none;">Produits</a>
						</li>
						<li style="color: var(--color-text-light);">/</li>
						<li style="color: var(--color-text-light);">Édition</li>
					</ol>
				</nav>
				<h1 style="font-size: 2.8rem; font-weight: 800; color: var(--color-dark); margin: 0; letter-spacing: -1px;">
					Modifier le
					<span style="color: var(--color-primary);">produit</span>
				</h1>
			</div>
			<a href="{{ path('app_admin_products') }}" class="btn btn-secondary" style="border-radius: 12px; padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 0.5rem; background: #f0f0f0; color: #333; border: 1px solid #ddd;">
				<i class="fas fa-arrow-left"></i>
				Retour
			</a>
		</div>

		<div style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); padding: 3rem; position: relative; overflow: hidden;">
			<div style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--color-primary), var(--color-accent));"></div>

			{{ form_start(form) }}
			<div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 4rem;">
				<div class="form-sections">
					<section style="margin-bottom: 2.5rem;">
						<h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
							<div style="width: 32px; height: 32px; background: rgba(37, 99, 235, 0.1); color: var(--color-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">1</div>
							Informations générales
						</h3>
						<div style="display: flex; flex-direction: column; gap: 1.5rem;">
							<div class="custom-form-row">
								{{ form_label(form.name) }}
								{{ form_widget(form.name, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
							</div>
							<div class="custom-form-row">
								{{ form_label(form.category) }}
								{{ form_widget(form.category, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
							</div>
							<div class="custom-form-row">
								{{ form_label(form.description) }}
								{{ form_widget(form.description, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem; min-height: 150px;'}}) }}
							</div>
						</div>
					</section>

					<section>
						<h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
							<div style="width: 32px; height: 32px; background: rgba(37, 99, 235, 0.1); color: var(--color-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">2</div>
							Prix et Stock
						</h3>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
							<div class="custom-form-row">
								{{ form_label(form.price) }}
								<div style="position: relative;">
									{{ form_widget(form.price, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
								</div>
							</div>
							<div class="custom-form-row">
								{{ form_label(form.stock) }}
								<div style="position: relative;">
									{{ form_widget(form.stock, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
								</div>
							</div>
						</div>
					</section>
				</div>

				<div class="image-upload-section">
					<section style="background: #f8fafc; border-radius: 20px; padding: 2rem; height: 100%;">
						<h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
							<i class="fas fa-image" style="color: var(--color-primary);"></i>
							Image du produit
						</h3>

						<div id="image-upload-wrapper" class="drag-drop-zone-container" style="margin-bottom: 2rem;">
							<div id="image-preview-container" class="drag-drop-zone" style="position: relative; aspect-ratio: 1; border-radius: 20px; overflow: hidden; border: 2px dashed #cbd5e0; display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
								{% if product.imageName %}
									<img id="current-image" src="{{ asset('uploads/products/' ~ product.imageName) }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: all 0.5s ease;">
								{% else %}
									<div id="image-placeholder" style="text-align: center; color: #a0aec0; transition: all 0.3s ease;">
										<div class="upload-icon-wrapper" style="width: 64px; height: 64px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: var(--color-primary); transition: all 0.3s ease;">
											<i class="fas fa-cloud-upload-alt" style="font-size: 1.8rem;"></i>
										</div>
										<p style="font-size: 1rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem;">Glissez-déposez</p>
										<p style="font-size: 0.8rem; opacity: 0.7;">ou cliquez pour parcourir</p>
									</div>
								{% endif %}

								<img id="image-preview" src="" alt="Nouvel aperçu" style="display: none; width: 100%; height: 100%; object-fit: cover; animation: zoomIn 0.3s ease-out;">

								<div id="upload-overlay" style="position: absolute; inset: 0; background: rgba(37, 99, 235, 0.9); display: none; align-items: center; justify-content: center; color: white; flex-direction: column; gap: 1rem; backdrop-filter: blur(4px); z-index: 10;">
									<i class="fas fa-file-image fa-3x animate-bounce"></i>
									<span class="fw-bold">Relâchez l'image ici</span>
								</div>

								<div id="preview-badge" style="display: none; position: absolute; top: 1rem; right: 1rem; background: var(--color-primary); color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 5;">
									NOUVEAU
								</div>
							</div>

							<div class="upload-control" style="margin-top: 1.5rem;">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
									{{ form_label(form.image, 'Fichier image', {'label_attr': {'style': 'font-weight: 700; color: #1e293b; margin: 0;'}}) }}
									<button type="button" id="reset-image" style="display: none; background: none; border: none; color: #ef4444; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
										<i class="fas fa-times-circle"></i>
										Annuler
									</button>
								</div>
								<div class="file-input-wrapper" style="position: relative; height: 48px;">
									{{ form_widget(form.image, {'attr': {'class': 'custom-file-input', 'id': 'product-image-input', 'accept': 'image/jpeg,image/png,image/webp', 'style': 'opacity: 0; position: absolute; inset: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;'}}) }}
									<div id="file-name-display" style="position: absolute; inset: 0; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0 1rem; font-size: 0.9rem; color: #64748b; display: flex; align-items: center; justify-content: space-between; z-index: 1;">
										<div style="display: flex; align-items: center; gap: 0.5rem;">
											<i class="fas fa-file-image"></i>
											<span>Aucun nouveau fichier choisi</span>
										</div>
										<span style="background: var(--color-primary); color: white; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">Parcourir</span>
									</div>
								</div>
								<p style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.75rem; line-height: 1.4;">
									<i class="fas fa-info-circle"></i>
									Formats acceptés : JPG, PNG, WEBP (Max: 2Mo).
								</p>
							</div>
						</div>
					</section>
				</div>
			</div>

			<div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center;">
				<div style="display: flex; gap: 1rem;">
					<button type="submit" class="btn" style="background: var(--color-primary); color: white; padding: 1rem 2.5rem; border-radius: 14px; font-weight: 600; font-size: 1.1rem; box-shadow: 0 10px 15px rgba(37, 99, 235, 0.2); transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem;">
						<i class="fas fa-save"></i>
						Enregistrer
					</button>
				</div>
			</div>
			{{ form_end(form) }}

			{# Hidden delete form attached to the button below for spacing #}
			<div style="position: absolute; bottom: 3rem; right: 3rem;">
				<form method="post" action="{{ path('app_admin_product_delete', {'id': product.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?');">
					<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ product.id) }}">
					<button class="btn" style="background: transparent; color: #e53e3e; font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
						<i class="fas fa-trash-alt"></i>
						Supprimer définitivement
					</button>
				</form>
			</div>
		</div>
	</div>

	<style>
		.custom-form-row {
			display: flex;
			flex-direction: column;
		}

		.custom-form-row label {
			display: block;
			font-weight: 600;
			color: #2d3748;
			margin-bottom: 0.75rem;
			font-size: 0.95rem;
			height: auto;
		}

		input:focus,
		textarea:focus {
			border-color: var(--color-primary) !important;
			box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important;
			outline: none;
		}

		.btn:hover {
			transform: translateY(-2px);
			filter: brightness(1.1);
		}

		.admin-container {
			animation: fadeIn 0.6s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes zoomIn {
			from {
				transform: scale(0.9);
				opacity: 0;
			}
			to {
				transform: scale(1);
				opacity: 1;
			}
		}

		.drag-drop-zone.active-drag {
			border-color: var(--color-primary) !important;
			border-style: solid !important;
			transform: scale(1.02);
			box-shadow: 0 10px 25px rgba(37, 99, 235, 0.15);
		}

		.drag-drop-zone:hover .upload-icon-wrapper {
			transform: translateY(-5px);
			background: rgba(37, 99, 235, 0.1);
		}

		.animate-bounce {
			animation: bounce 1s infinite;
		}

		@keyframes bounce {
			0,
			100% {
				transform: translateY(-10%);
				animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
			}
			50% {
				transform: translateY(0);
				animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
			}
		}
	</style>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
const imageInput = document.getElementById('product-image-input') || document.querySelector('input[type="file"]');
const imagePreview = document.getElementById('image-preview');
const imagePlaceholder = document.getElementById('image-placeholder');
const currentImage = document.getElementById('current-image');
const imageContainer = document.getElementById('image-preview-container');
const uploadOverlay = document.getElementById('upload-overlay');
const previewBadge = document.getElementById('preview-badge');
const fileNameDisplay = document.querySelector('#file-name-display span');
const resetBtn = document.getElementById('reset-image');

if (! imageInput || ! imageContainer) 
return;



function handleImageFile(file) {
if (! file || ! file.type.startsWith('image/')) 
return;



const reader = new FileReader();
reader.onload = function (e) {
imagePreview.src = e.target.result;
imagePreview.style.display = 'block';
if (previewBadge) 
previewBadge.style.display = 'block';


if (currentImage) 
currentImage.style.opacity = '0.3';


if (imagePlaceholder) 
imagePlaceholder.style.display = 'none';


fileNameDisplay.textContent = file.name;
resetBtn.style.display = 'block';
imageContainer.style.borderColor = 'var(--color-primary)';
imageContainer.style.borderStyle = 'solid';
};
reader.readAsDataURL(file);
}

// Prevent browser from opening the file when dropped outside the zone
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
document.addEventListener(name, e => {
if (! imageContainer.contains(e.target)) {
e.preventDefault();
}
}, false);
});

// Sync input with drag and drop using DataTransfer for better compatibility
imageContainer.addEventListener('drop', e => {
e.preventDefault();
e.stopPropagation();

const files = e.dataTransfer.files;
if (files.length) {
try {
const dt = new DataTransfer();
dt.items.add(files[0]);
imageInput.files = dt.files;
imageInput.dispatchEvent(new Event('change', {bubbles: true}));
} catch (err) {
imageInput.files = files;
imageInput.dispatchEvent(new Event('change', {bubbles: true}));
}
}
});

imageInput.addEventListener('change', e => {
if (e.target.files.length) {
handleImageFile(e.target.files[0]);
}
});

// Visual feedback
['dragenter', 'dragover'].forEach(name => {
imageContainer.addEventListener(name, e => {
e.preventDefault();
e.stopPropagation();
imageContainer.classList.add('active-drag');
if (uploadOverlay) 
uploadOverlay.style.display = 'flex';


});
});

['dragleave', 'drop'].forEach(name => {
imageContainer.addEventListener(name, e => {
e.preventDefault();
e.stopPropagation();
imageContainer.classList.remove('active-drag');
if (uploadOverlay) 
uploadOverlay.style.display = 'none';


});
});

// Click to upload
imageContainer.addEventListener('click', (e) => {
if (e.target === resetBtn || resetBtn.contains(e.target)) 
return;


imageInput.click();
});

// Reset functionality
resetBtn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();
imageInput.value = '';
imagePreview.style.display = 'none';
if (previewBadge) 
previewBadge.style.display = 'none';


if (currentImage) 
currentImage.style.opacity = '1';


if (imagePlaceholder) 
imagePlaceholder.style.display = 'block';


fileNameDisplay.textContent = 'Aucun nouveau fichier choisi';
resetBtn.style.display = 'none';
imageContainer.style.borderColor = '#cbd5e0';
imageContainer.style.borderStyle = 'dashed';
});
});
	</script>
{% endblock %}
